<!-- templates/templates.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Templates | DocGen-Mongo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container mt-4">
        {% include 'alerts.html' %}

        <h2>Manage Templates</h2>

        <!-- Button to show/hide Add Template form - Visible to Admin and HR -->
        {% if current_user.role in ['admin', 'hr'] %}
        <button class="btn btn-success mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#addTemplateForm" aria-expanded="false" aria-controls="addTemplateForm">
            + Add New Template
        </button>
        {% endif %}

        <!-- Add Template Form -->
        <div class="collapse" id="addTemplateForm">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white">Create Template</div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('manage_templates') }}">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control") }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.type.label(class="form-label") }}
                            {{ form.type(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.content.label(class="form-label") }}
                            {{ form.content(class="form-control", rows="6") }}
                            <small class="form-text text-muted">
                                You can use placeholders like {{ "{{name}}" }}, {{ "{{email}}" }}, {{ "{{role}}" }}, {{ "{{start_date}}" }}, {{ "{{end_date}}" }} which will be automatically replaced with the candidate's data.
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-success">üíæ Save Template</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- List of templates -->
        {% if templates %}
            {% for template in templates %}
                <div class="card mb-2">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ template.name }}</h5>
                            <small class="text-muted">{{ template.type }}</small>
                        </div>
                        <div>
                            <!-- Edit is visible to Admin/HR -->
                            {% if current_user.role in ['admin', 'hr'] %}
                            <a href="{{ url_for('edit_template', id=template._id) }}" class="btn btn-warning btn-sm">‚úèÔ∏è Edit</a>
                            {% endif %}
                            <!-- Delete is visible to Admin only -->
                            {% if current_user.role == 'admin' %}
                            <a href="{{ url_for('delete_template', id=template._id) }}" 
                               class="btn btn-danger btn-sm"
                               onclick="return confirm('Are you sure you want to delete this template?')">üóëÔ∏è Delete</a>
                            {% endif %}
                            <!-- Preview is visible to all roles -->
                            <button class="btn btn-info btn-sm"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#previewModal"
                                    onclick="loadPreview('{{ template._id }}')">üëÅÔ∏è Preview</button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info mt-3">No templates found. Add one!</div>
        {% endif %}
    </div>

    <!-- Bootstrap Modal for Preview -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Template Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="previewContent">
                    <div class="text-center text-muted">Loading preview...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function loadPreview(templateId) {
            const previewContent = document.getElementById("previewContent");
            previewContent.innerHTML = '<div class="text-center text-muted">Loading preview...</div>';

            fetch(`/preview_template/${templateId}`)
                .then(response => response.text())
                .then(html => {
                    previewContent.innerHTML = html;
                })
                .catch(err => {
                    previewContent.innerHTML = '<div class="text-danger">Error loading preview.</div>';
                });
        }
    </script>
</body>
</html>
